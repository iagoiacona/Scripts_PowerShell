#Parte1 
#Config Variables
$SiteURL = "https://rockencantech.sharepoint.com/sites/marketingll"
$ClientID = "9d6b1a14-3b6a-4f65-babd-3119c5b79898"
$ListName="Shared Documents"
$VersionsToKeep = 10

#Parte2
#Connect to PnP Online
Connect-PnPOnline -Url $SiteURL -ClientId $ClientID #-UseWebLogin

#Parte3 
#Get the Context
$Ctx= Get-PnPContext
#Get All Items from the List - Exclude 'Folder' List Items
$ListItems = Get-PnPListItem -List $ListName -PageSize 500 -Fields Author, Editor, Created, File_x0020_Type -ScriptBlock `
       { Param($items) $global:counter += $items.Count; Write-Progress -Activity `
            "Getting Documents from Library '$($List.Title)'" -Status "Getting Documents data $global:Counter of $($List.ItemCount)";} | Where {$_.FileSystemObjectType -eq "File"}
#$ListItems = Get-PnPListItem -List $ListName -Query "<View Scope='RecursiveAll'><Query><Where><Eq><FieldRef Name='FSObjType'/><Value Type='Integer'>0</Value></Eq></Where></Query></View>"

#Parte4
ForEach ($Item in $ListItems) {
   #Get File Versions
   $File = $Item.File
   $Versions = $File.Versions
   $Ctx.Load($File)
   $Ctx.Load($Versions)
   $Ctx.ExecuteQuery()
   Write-host -f Yellow "Scanning File:"$File.Name
   $VersionsCount = $Versions.Count
   $VersionsToDelete = $VersionsCount - $VersionsToKeep
   If($VersionsToDelete -gt 0)
   {
       write-host -f Cyan "`t Total Number of Versions of the File:" $VersionsCount
       #Delete versions
       For($i=0; $i -lt $VersionsToDelete; $i++)
       {
           write-host -f Cyan "`t Deleting Version:" $Versions[0].VersionLabel
           $Versions[0].DeleteObject()
       }
       $Ctx.ExecuteQuery()
       Write-Host -f Green "`t Version History is cleaned for the File:"$File.Name
   }
}
